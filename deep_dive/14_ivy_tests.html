<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ivy Tests &mdash; Ivy 1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="icon" type="image/png" href="https://github.com/unifyai/unifyai.github.io/blob/master/img/externally_linked/ivy_logo_only.png?raw=true">
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Open Tasks" href="../contributing/4_open_tasks.html" />
    <link rel="prev" title="Array API Tests" href="13_array_api_tests.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Ivy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extensions.html">Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../deep_dive.html">Deep Dive</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="0_navigating_the_code.html">Navigating the Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="1_function_types.html">Function Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="2_backend_setting.html">Backend Setting</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_function_wrapping.html">Function Wrapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="4_arrays.html">Arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="5_containers.html">Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="6_data_types.html">Data Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="7_devices.html">Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="8_inplace_updates.html">Inplace Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="9_formatting.html">Formatting</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_function_arguments.html">Function Arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="11_docstrings.html">Docstrings</a></li>
<li class="toctree-l2"><a class="reference internal" href="12_docstring_examples.html">Docstring Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="13_array_api_tests.html">Array API Tests</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Ivy Tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Hypothesis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-generation">Data Generation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#important-strategies">Important Strategies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#integration-of-strategies-into-ivy-tests">Integration of Strategies into Ivy Tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#why-do-we-need-helper-functions">Why do we need helper functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-write-hypothesis-tests-effectively">How to write Hypothesis Tests effectively</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bonus-hypothesis-extended-features">Bonus: Hypothesis’ Extended Features</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#self-consistent-and-explicit-testing">Self-Consistent and Explicit Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">test_array_function</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/activations.html">Activations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/compilation.html">Compilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/constants.html">Constants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/creation.html">Creation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/data_type.html">Data type</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/device.html">Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/elementwise.html">Elementwise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/general.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/gradients.html">Gradients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/layers.html">Layers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/linear_algebra.html">Linear algebra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/losses.html">Losses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/manipulation.html">Manipulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/meta.html">Meta</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/nest.html">Nest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/norms.html">Norms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/random.html">Random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/searching.html">Searching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/set.html">Set</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/sorting.html">Sorting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/statistical.html">Statistical</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functional/ivy/utility.html">Utility</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Stateful</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../stateful/activations.html">Activations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stateful/converters.html">Converters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stateful/initializers.html">Initializers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stateful/layers.html">Layers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stateful/module.html">Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stateful/norms.html">Norms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stateful/optimizers.html">Optimizers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stateful/sequential.html">Sequential</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ivy"">Ivy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mech"">Ivy mech</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vision"">Ivy vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../robot"">Ivy robot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gym"">Ivy gym</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../memory"">Ivy memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../builder"">Ivy builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models"">Ivy models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ecosystem"">Ivy ecosystem</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ivy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../contributing.html">Contributing</a> &raquo;</li>
          <li><a href="../deep_dive.html">Deep Dive</a> &raquo;</li>
      <li>Ivy Tests</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/deep_dive/14_ivy_tests.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ivy-tests">
<h1>Ivy Tests<a class="headerlink" href="#ivy-tests" title="Permalink to this heading"></a></h1>
<p>On top of the Array API <a class="reference external" href="https://github.com/data-apis/array-api-tests">test suite</a>, which is included as a submodule mapped to the folder <code class="code docutils literal notranslate"><span class="pre">test_array_api</span></code>,
there is also a collection of Ivy tests, located in subfolder <a class="reference external" href="https://github.com/unifyai/ivy/tree/0fc4a104e19266fb4a65f5ec52308ff816e85d78/ivy_tests/test_ivy">test_ivy</a>.</p>
<p>These tests serve two purposes:</p>
<ol class="arabic simple">
<li><p>test functions and classes which are <em>not</em> part of the standard</p></li>
<li><p>test additional required behaviour for functions which <em>are</em> part of the standard.
The standard only mandates a subset of required behaviour, which the Ivy functions generally extend upon.</p></li>
</ol>
<p>As done in the <a class="reference external" href="https://github.com/data-apis/array-api-tests">test suite</a>, we also make use of <a class="reference external" href="https://hypothesis.readthedocs.io/en/latest/">hypothesis</a> for performing property based testing.</p>
<section id="id1">
<h2>Hypothesis<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h2>
<p>Using pytest fixtures (such as the ones removed in this <a class="reference external" href="https://github.com/unifyai/ivy/commit/8e6074419c0b6ee27c52e8563374373c8bcff30f">commit</a>) cause a grid search to be performed for all
combinations of parameters. This is great when we want the test to be very thorough,
but can make the entire test suite very time consuming.
Before the changes in this commit, there were 300+ separate tests being run in total,
just for this <code class="code docutils literal notranslate"><span class="pre">ivy.abs</span></code> function.
If we take this approach for every function, we might hit the runtime limit permitted by GitHub actions.</p>
<p>A more elegant and efficient solution is to use the <a class="reference external" href="https://hypothesis.readthedocs.io/en/latest/">hypothesis</a> module,
which intelligently samples from all of the possible combinations within user-specified ranges,
rather than grid searching all of them every single time.
The intelligent sampling is possible because hypothesis enables the results of previous test runs to be cached,
and then the new samples on subsequent runs are selected intelligently,
avoiding samples which previously passed the tests, and sampling for unexplored combinations.
Combinations which are known to have failed on previous runs are also repeatedly tested for.
With the <a class="reference external" href="https://github.com/unifyai/ivy/blob/0fc4a104e19266fb4a65f5ec52308ff816e85d78/.github/workflows/test-array-api-torch.yml#L30">uploading</a> and <a class="reference external" href="https://github.com/unifyai/ivy/blob/0fc4a104e19266fb4a65f5ec52308ff816e85d78/.github/workflows/test-array-api-torch.yml#L14">downloading</a> of the <code class="code docutils literal notranslate"><span class="pre">.hypothesis</span></code> cache as an <a class="reference external" href="https://docs.github.com/en/actions/using-workflows/storing-workflow-data-as-artifacts">artifact</a>,
these useful properties are also true in Ivy’s GitHub Action <a class="reference external" href="https://github.com/unifyai/ivy/tree/0fc4a104e19266fb4a65f5ec52308ff816e85d78/.github/workflows">continuous integration</a> (CI) tests.</p>
<p>Rather than making use of <code class="code docutils literal notranslate"><span class="pre">pytest.mark.parametrize</span></code>, the Ivy tests make use of hypothesis <a class="reference external" href="https://hypothesis.readthedocs.io/en/latest/data.html">search strategies</a>.
This reference <a class="reference external" href="https://github.com/unifyai/ivy/commit/8e6074419c0b6ee27c52e8563374373c8bcff30f">commit</a> outlines the difference between using pytest parametrizations and hypothesis,
for <code class="code docutils literal notranslate"><span class="pre">ivy.abs</span></code>.
Among other changes, all <code class="code docutils literal notranslate"><span class="pre">pytest.skip()</span></code> calls were replaced with return statements,
as pytest skipping does not play nicely with hypothesis testing.</p>
</section>
<section id="data-generation">
<h2>Data Generation<a class="headerlink" href="#data-generation" title="Permalink to this heading"></a></h2>
<p>The way data is generated is described by the <code class="code docutils literal notranslate"><span class="pre">hypothesis.strategies</span></code> module which contains a variety of <a class="reference external" href="https://hypothesis.readthedocs.io/en/latest/data.html">methods</a>
that have been used widely in each of Ivy’s functional and stateful submodule tests. An initialized strategy is a object
that is used by Hypothesis to generate data for the test. For example, let’s write a strategy that generates supported
integer data types in Ivy -:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">valid_int_dtypes</span> <span class="o">=</span>  <span class="p">(</span><span class="n">int8</span><span class="p">,</span><span class="n">int16</span><span class="p">,</span><span class="n">int32</span><span class="p">,</span><span class="n">int64</span><span class="p">,</span><span class="n">uint8</span><span class="p">,</span> <span class="n">uint16</span><span class="p">,</span> <span class="n">uint32</span><span class="p">,</span> <span class="n">uint64</span><span class="p">)</span>
<span class="n">custom_strategy</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">lists</span><span class="p">(</span> <span class="n">st</span><span class="o">.</span><span class="n">sampled_from</span><span class="p">(</span><span class="n">valid_int_dtypes</span><span class="p">),</span> <span class="n">min_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>We are simply generating lists of arbitrary lengths within the range [0,4], wherein the elements correspond to the
valid_int_dtypes <strong>tuple</strong>. Let’s define a template function for printing examples generated by the hypothesis integrated
test functions.</p>
<p><strong>Note</strong> - : This function will be referenced later in the section.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_hypothesis_examples</span><span class="p">(</span><span class="n">st</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">SearchStrategy</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Example run </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> -: </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">example</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)]</span>
</pre></div>
</div>
<p>Check the results of our strategy-:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">print_hypothesis_examples</span><span class="p">(</span> <span class="n">custom_strategy</span> <span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="p">[</span><span class="s1">&#39;int8&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span> <span class="s1">&#39;int16&#39;</span><span class="p">,</span> <span class="s1">&#39;int16&#39;</span><span class="p">,</span> <span class="s1">&#39;int32&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>Note</strong> - : The output will be randomised in each run. This is quite a simplistic example and doesn’t cover the
intricacies behind the helper functions in the <em>test_ivy</em> directory.</p>
<p>In the example above, <strong>st.lists</strong> and <strong>st.sampled_from</strong> are what we call strategies. To briefly describe -:</p>
<p>1. <strong>sampled_from</strong> accepts a collection of objects. This strategy will return a value that is sampled from this
collection.</p>
<p>2. <strong>lists</strong> accepts another strategy which describes the elements of the list being generated. This is best used when
a sequence of varying lengths is required to be generated, with elements that are described by other strategies. The
following parameters can be specified by the user-:</p>
<ul class="simple">
<li><p>Bounds on the length of the list.</p></li>
<li><p>If we want the elements to be unique.</p></li>
<li><p>A mechanism for defining “uniqueness”.</p></li>
</ul>
<section id="important-strategies">
<h3>Important Strategies<a class="headerlink" href="#important-strategies" title="Permalink to this heading"></a></h3>
<p>It might be helpful to look at a few more strategies, since they are widely used across the  helper functions to
generate custom data -:</p>
<ol class="arabic simple" start="3">
<li><p><strong>booleans</strong> - generates boolean values True or False</p></li>
<li><p><strong>integers</strong> - generates integers values within a given range</p></li>
</ol>
<p>5. <strong>float</strong> -  It is a powerful strategy that generates all variety of floats, including math.inf and math.nan.
You can also specify:</p>
<ul class="simple">
<li><p>Math.inf and math.nan, respectively, should be included in the data description.</p></li>
<li><p>Bounds(either inclusive or exclusive) on the floats being generated.</p></li>
<li><p>The width of the floats; eg; if you want to generate 16-bit or 32 bit floats vs 64 bit. Python floats are always
64-bit, width=32 ensures that the generated values can always be losslessly represented in both 32 bits. This is
mostly useful for Numpy arrays).</p></li>
</ul>
<ol class="arabic simple" start="6">
<li><p><strong>none</strong> - returns a strategy which only generates None.</p></li>
</ol>
<p>7. <strong>tuples</strong> - The strategy accepts N Hypothesis strategies, and will generate length - N tuples whose elements are drawn
from the respective strategies that were specified as inputs.</p>
<p>8. <strong>one_of</strong> - This allows us to specify a collection of strategies and any given datum will be drawn from “one of” them.
Hypothesis has the <em>pipe</em> operator overloaded as a shorthand for one_of. This has been widely used all over in Ivy Tests.
For example, this <a class="reference external" href="https://github.com/unifyai/ivy/blob/master/ivy_tests/test_ivy/test_functional/test_core/test_manipulation.py#L476">line</a> here, can also be written as -:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">st</span><span class="o">.</span><span class="n">one_of</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">none</span><span class="p">(),</span> <span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="o">-</span><span class="n">ndim</span><span class="p">,</span> <span class="n">ndim</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>9. <strong>shared</strong> - This returns a strategy that draws a shared value per run, drawn from base. Any two shared instances with
the same key will share the same value. For example, <a class="reference external" href="https://github.com/unifyai/ivy/blob/master/ivy_tests/test_ivy/test_functional/test_core/test_creation.py#L192">here</a>, the parameters, <em>dtype_and_x</em> and <em>num_positional_args</em> share
the same key <em>num_arrays</em>, hence similar values will be drawn for both arguments.</p>
<p>10. <strong>sets</strong> - This is used for generating a <em>unique collection</em> of elements. Like <strong>st.lists</strong> it accepts another strategy
which describes the elements of the set being generated.</p>
<ol class="arabic simple" start="11">
<li><p><strong>map</strong> - The map method, permits us to perform a mapping on the data being produced by a strategy.</p></li>
</ol>
<p>12. <strong>filter</strong> - Data is filtered using this method. It takes a callable that accepts as input the data generated by the
strategy, and returns:</p>
<ul class="simple">
<li><p>True if the data should pass through the filter</p></li>
<li><p>False if the data should be rejected by the filter</p></li>
</ul>
<ol class="arabic simple" start="13">
<li><p><strong>flatmap</strong> - This enables us to define a strategy based on a value drawn from a previous strategy.</p></li>
</ol>
<p>14. <strong>data</strong> - This is one of the <strong>most</strong> important strategies used in the project. It will often be the case that it is
required to draw strategies in a context-dependent manner within the test. Suppose, we want to generate an array of
values in some ivy test, but we want make sure that those values are only of the valid float types supported by Ivy.
The st.data() strategy can be used <em>interactively</em>, and values can be drawn at test-time, using <strong>data.draw()</strong> method.</p>
<p>The <strong>given</strong> operator usually contains the data parameter, which is an instance of the <strong>st.DataObject</strong> class; this
instance is what gets drawn from the st.data() strategy. For example, at <a class="reference external" href="https://github.com/unifyai/ivy/blob/master/ivy_tests/test_ivy/test_functional/test_core/test_sorting.py#L18">this</a> line the keyword arguments for the
function <em>test_argsort</em>, have been generated only after the generation of the array.</p>
<p>15. <strong>composite</strong> - The second <strong>most</strong> widely used strategy in <em>Ivy tests</em>. This provides a decorator, which permits us to
form our own strategies for describing data by composing Hypothesis’ built-in strategies. For <a class="reference external" href="https://github.com/unifyai/ivy/blob/master/ivy_tests/test_ivy/helpers.py#L1054">example</a>.</p>
</section>
<section id="integration-of-strategies-into-ivy-tests">
<h3>Integration of Strategies into Ivy Tests<a class="headerlink" href="#integration-of-strategies-into-ivy-tests" title="Permalink to this heading"></a></h3>
<p>Once a strategy is initialised the <strong>given</strong> decorator is added to the test function for drawing values from the strategy
and passing them as inputs to the test. For example, in this code snippet here -:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@given</span><span class="p">(</span>
<span class="n">dtype_and_x</span><span class="o">=</span><span class="n">helpers</span><span class="o">.</span><span class="n">dtype_and_values</span><span class="p">(</span><span class="n">ivy_np</span><span class="o">.</span><span class="n">valid_float_dtypes</span><span class="p">),</span>
<span class="n">as_variable</span><span class="o">=</span><span class="n">helpers</span><span class="o">.</span><span class="n">list_of_length</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">booleans</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
<span class="n">native_array</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">booleans</span><span class="p">(),</span>
<span class="n">num_positional_args</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="n">container</span><span class="o">=</span><span class="n">helpers</span><span class="o">.</span><span class="n">list_of_length</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">booleans</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
<span class="n">instance_method</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">booleans</span><span class="p">(),</span>
<span class="n">alpha</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">floats</span><span class="p">(),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_leaky_relu</span><span class="p">(</span>
<span class="n">dtype_and_x</span><span class="p">,</span>
<span class="n">alpha</span><span class="p">,</span>
<span class="n">as_variable</span><span class="p">,</span>
<span class="n">num_positional_args</span><span class="p">,</span>
<span class="n">container</span><span class="p">,</span>
<span class="n">instance_method</span><span class="p">,</span>
<span class="n">native_array</span><span class="p">,</span>
<span class="n">fw</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">dtype</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">dtype_and_x</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ivy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ivy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ivy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="ow">or</span> <span class="ow">not</span>\
    <span class="n">ivy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ivy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alpha</span><span class="p">])):</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">fw</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float16&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">helpers</span><span class="o">.</span><span class="n">test_function</span><span class="p">(</span>
                    <span class="n">dtype</span><span class="p">,</span>
                    <span class="n">as_variable</span><span class="p">,</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="n">native_array</span><span class="p">,</span>
                    <span class="n">fw</span><span class="p">,</span>
                    <span class="n">num_positional_args</span><span class="p">,</span>
                    <span class="n">container</span><span class="p">,</span>
                    <span class="n">instance_method</span><span class="p">,</span>
                    <span class="s2">&quot;leaky_relu&quot;</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,)</span>
</pre></div>
</div>
<p>In the test above, all parameters being exhaustively drawn inside the given block from hypothesis either
<strong>directly</strong> (<em>native_array, num_positional, instance_methods, alpha</em>) or <strong>indirectly</strong> (<em>dtype_and_x, as_variable, container</em>)
with the <em>helper</em> functions.</p>
<p><strong>Note</strong> - It is advisable to specify the parameters of given as keyword arguments, so that there’s a correspondence
between our strategies with the function-signature’s parameters.</p>
<p>As  discussed above, the helper functions use the composite decorator, which helps in defining a series of custom strategies.
It can be seen that <em>dtype_and_x</em> uses the <strong>dtype_and_values</strong> strategy to generate valid float data types and corresponding
array elements, whose shapes can be specified manually or are assumed by default. The generated data is returned as a tuple.
Let’s look at the data produced by this strategy -:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">dtype_and_values</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">9433925.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.401298464324817e-45</span><span class="p">])</span>
<span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="p">[[</span><span class="mf">574352379.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.99999</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.2250738585072014e-308</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.103515625e-05</span><span class="p">]])</span>
</pre></div>
</div>
<p>These values are then unpacked, converted to <code class="code docutils literal notranslate"><span class="pre">ivy.array</span></code> class, with corresponding dtypes. The test then runs on the newly
created arrays with specified dtypes. Similar is the case with other parameters which the function above is required to test.</p>
</section>
<section id="why-do-we-need-helper-functions">
<h3>Why do we need helper functions<a class="headerlink" href="#why-do-we-need-helper-functions" title="Permalink to this heading"></a></h3>
<p>It is usually the case that any ivy function should run seamlessly on ‘all the possible varieties, as well as  the edge
cases’ encountered by the following parameters -:</p>
<ul class="simple">
<li><p>All possible data types - <strong>composite</strong></p></li>
<li><p>Boolean array types if the function expects one - <strong>composite</strong></p></li>
<li><p>Possible range of values within each data type - <strong>composite</strong></p></li>
<li><p>When input is a container - <strong>boolean</strong></p></li>
<li><p>When the function can also be called as an instance method - <strong>boolean</strong></p></li>
<li><p>When the input is a native array - <strong>boolean</strong></p></li>
<li><p>Out argument support, if the function has one - <strong>boolean</strong></p></li>
</ul>
<p><strong>Note</strong> -: Each test function has its own requirements and the parameter criterion listed above does not cover everything.</p>
<p>Sometimes the function requirements are straight-forward, for instance, generating integers, boolean values, float values.
Whereas, in the case of specific parameters like -:</p>
<ul class="simple">
<li><p>array_values</p></li>
<li><p>data_types</p></li>
<li><p>valid_axes</p></li>
<li><p>lists or tuples or sequence of varied input types( the test_leaky_relu function above)</p></li>
<li><p>generating subsets at test time</p></li>
<li><p>generating arbitrary shapes of arrays at test time</p></li>
<li><p>getting axes at test time</p></li>
</ul>
<p>We need a hand-crafted data generation policy(composite). For this purpose ad-hoc functions have been defined in the
<code class="code docutils literal notranslate"><span class="pre">helpers.py</span></code> file. It might be appropriate now, to bring them up and discuss their use. A detailed overview of their working
is as follows-:</p>
<p>1. <strong>array_dtypes</strong> - As the name suggests, this will generate arbitrary sequences of valid float data types. The sequence
parameters like <em>min_size</em>, and <em>max_size</em>, are specified at test time based on the function. This is what the function
returns -:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#a sequence of floats with arbitrary lengths ranging from [1,5]</span>
<span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">array_dtypes</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)))</span>

<span class="p">[</span><span class="s1">&#39;float16&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="s1">&#39;float16&#39;</span><span class="p">,</span> <span class="s1">&#39;float16&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="s1">&#39;float16&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>This function should be used whenever we are testing an ivy function that accepts at least one array as an input.</p>
<ol class="arabic simple" start="2">
<li><p><strong>array_bools</strong> - This function generates a sequence of boolean values. For example-:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">array_bools</span><span class="p">(</span><span class="n">na</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)))</span>

<span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
<span class="p">[</span><span class="kc">False</span><span class="p">]</span>
</pre></div>
</div>
<p>This function should be used when a boolean value is to be associated for each value of the other parameter, when
generated by a sequence. For example, in <a class="reference external" href="https://github.com/unifyai/ivy/blob/master/ivy_tests/test_ivy/test_functional/test_core/test_manipulation.py#L38">test_concat</a>, we are generating a list of inputs of the dimension (2,3), and
for each input we have three boolean values associated with it that define additional parameters(container, as_variable
, native_array). Meaning if the input is to be treated as a container, at the same time, is it a variable or a native array.</p>
<p>3. <strong>lists</strong> - As the name suggests, we use it to generate lists composed of anything, as specified by the user. For example
in <a class="reference external" href="https://github.com/unifyai/ivy/blob/master/ivy_tests/test_ivy/test_functional/test_core/test_device.py">test_device</a> file, it is used to generate a list of array_shapes, in <a class="reference external" href="https://github.com/unifyai/ivy/blob/master/ivy_tests/test_ivy/test_functional/test_core/test_manipulation.py">test_manipulation</a>, it is used to generate a list
of common_shapes, and more in <a class="reference external" href="https://github.com/unifyai/ivy/blob/master/ivy_tests/test_ivy/test_functional/test_nn/test_layers.py">test_layers</a>. The function takes in 3 arguments, first is the strategy by which the elements
are to be generated, in majority of the cases this is <strong>st.integers</strong>, with range specified, and the other arguments are
sequence arguments as specified in <strong>array_dtypes</strong>. For example -:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">lists</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">min_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">max_size</span> <span class="o">=</span> <span class="mi">5</span><span class="p">))</span>

<span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>The generated values are then passed to the array creation functions inside the test function as tuples.</p>
<ol class="arabic simple" start="4">
<li><p><strong>valid_axes</strong> - This function generates valid axes for a given array dimension. For example -:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">valid_axes</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">size_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]))</span>

<span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>It should be used in functions which expect axes as a required or an optional argument.</p>
<p>5. <strong>integers</strong> - This is similar to the <em>st.integers</em> strategy, with the only difference being that here the range can
either be specified manually, or a shared key can be provided. The way shared keys work has been discussed in the
<em>Important Strategies</em> sections above.</p>
<p>6. <strong>dtype_and_values</strong> - This function generates a tuple wherein the first element is a valid float data type, and the
second element is a list/nested list containing floating point numbers of that precision. For example-:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#ivy valid float types are those which are supported by numpy</span>
<span class="kn">import</span> <span class="nn">ivy.functional.backends.numpy</span> <span class="k">as</span> <span class="nn">ivy_np</span>
<span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">dtype_and_values</span><span class="p">(</span><span class="n">ivy_np</span><span class="o">.</span><span class="n">valid_float_dtypes</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

<span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="p">(</span><span class="s1">&#39;float16&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">283405296074752.0</span><span class="p">,</span> <span class="mf">564049465049088.0</span><span class="p">,</span> <span class="mf">1.0417876997507982e+16</span><span class="p">])</span>
</pre></div>
</div>
<p>This function contains a list of <a class="reference external" href="https://github.com/unifyai/ivy/blob/master/ivy_tests/test_ivy/helpers.py#L1100">keyword</a> arguments. To name a few, min_value, max_value, allow_inf, min_num_dims etc.
It can be used wherever an array of values with a specified data type is expected. That would again be a list a functions
which expects at least one <code class="code docutils literal notranslate"><span class="pre">ivy.array</span></code>.</p>
<p>7. <strong>reshape_shapes</strong> - This function returns a valid shape after a reshape operation is applied given as input of any
arbitrary shape. For example-:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">reshape_shapes</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>

<span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="mi">9</span><span class="p">,)</span>
<span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
</pre></div>
</div>
<p>It should be used in places where broadcast operations are run, either as a part of a larger computation or in a
stand-alone fashion.</p>
<p>8. <strong>subsets</strong> - As the function name suggests, it generates subsets of any sequence, and returns that subset as a tuple.
For example-:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">some_sequence</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tensorflow&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">3.06</span><span class="p">,</span> <span class="s1">&#39;torch&#39;</span><span class="p">,</span> <span class="s1">&#39;ivy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">subsets</span><span class="p">(</span><span class="n">some_sequence</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>

<span class="p">(</span><span class="s1">&#39;tensorflow&#39;</span><span class="p">,</span> <span class="s1">&#39;ivy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="s1">&#39;tensorflow&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">3.06</span><span class="p">,</span> <span class="s1">&#39;torch&#39;</span><span class="p">,</span> <span class="s1">&#39;ivy&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="s1">&#39;tensorflow&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;torch&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3.06</span><span class="p">)</span>
</pre></div>
</div>
<p>9. <strong>array_values</strong> - It works in a similar way as the <strong>dtype_and_values</strong> function, with the only difference being,
here an extensive set of parameters and sub-strategies are used to generate array values. For example-:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">input_dtype</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sampled_from</span><span class="p">(</span><span class="n">ivy_np</span><span class="o">.</span><span class="n">valid_float_dtypes</span><span class="p">)</span>
<span class="n">print_hypothesis_examples</span><span class="p">(</span>
                          <span class="n">array_values</span><span class="p">(</span>
                          <span class="n">input_dtype</span><span class="o">.</span><span class="n">example</span><span class="p">(),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span>
                              <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>   <span class="n">allow_subnormal</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                          <span class="n">exclude_min</span><span class="o">=</span><span class="kc">True</span>
                                      <span class="p">)</span>
                          <span class="p">)</span>

<span class="p">[</span><span class="mf">5.960464477539063e-08</span><span class="p">,</span> <span class="mf">5.960464477539063e-08</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
<span class="p">[</span><span class="mf">5.960464477539063e-08</span><span class="p">,</span> <span class="mf">5.960464477539063e-08</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
</pre></div>
</div>
<p>It ensures full coverage of the values that an array can have, given certain parameters like <em>allow_nan, allow_subnormal, allow_inf</em>.
Such parameters usually test the function for edge cases. This function should be used in places where the result doesn’t
depend on the kind of value an array contains.</p>
<p>10. <strong>get_shape</strong> - This is used to generate any arbitrary shape. If <em>allow_none</em> is set to <code class="code docutils literal notranslate"><span class="pre">True</span></code>, then an implicit
<em>st.one_of</em> strategy is used, wherein the function will either generate <code class="code docutils literal notranslate"><span class="pre">None</span></code> as shape or it will generate a shape
based on the keyword <a class="reference external" href="https://github.com/unifyai/ivy/blob/master/ivy_tests/test_ivy/helpers.py#L1337">arguments</a> of the function. For example -:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">print_hypothesis_examples</span><span class="p">(</span>
                          <span class="n">get_shape</span><span class="p">(</span>
                          <span class="n">allow_none</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">min_num_dims</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                          <span class="n">max_num_dims</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">min_dim_size</span> <span class="o">=</span> <span class="mi">2</span>
                                   <span class="p">),</span> <span class="mi">3</span>
                          <span class="p">)</span>
<span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<p>11. <strong>none_or_list_of_floats</strong> - This function is the same as array_values function, with the only difference being that here
data types other than float are not supported. User needs to pass in a <em>valid float type</em>, and the <em>size</em>. Here <code class="code docutils literal notranslate"><span class="pre">None</span></code>
type is <code class="code docutils literal notranslate"><span class="pre">True</span></code> by default. For example-:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">print_hypothesis_examples</span><span class="p">(</span>
                          <span class="n">none_or_list_of_floats</span><span class="p">(</span>
                          <span class="n">input_dtype</span><span class="o">.</span><span class="n">example</span><span class="p">(),</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                          <span class="n">min_value</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span> <span class="mf">200.0</span><span class="p">),</span><span class="mi">3</span>
                          <span class="p">)</span>
<span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mf">199.99999999999997</span><span class="p">,</span> <span class="mf">200.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">199.99999999999997</span><span class="p">]</span>
<span class="p">[</span><span class="mf">199.99999999999997</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">10.000000000000002</span><span class="p">,</span> <span class="mf">125.43759670925832</span><span class="p">]</span>
<span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">199.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">200.0</span><span class="p">]</span>
</pre></div>
</div>
<p>This function might come in handy when some float values are required for generating other data, or are part of a larger
computation. For example, <strong>get_mean_std</strong> strategy requires a series of values to generate the mean and standard deviation
for arbitrary input values.</p>
<p>12. <strong>get_mean_std</strong> - Strategies like this one are specific to a particular range of functions only. It comes in handy while
testing probabilistic functions like <em>random_normal</em>, and other distributions or statistical functions like <em>mean-squared-error</em>.
For example-:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">input_dtype</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sampled_from</span><span class="p">(</span><span class="n">ivy_np</span><span class="o">.</span><span class="n">valid_float_dtypes</span><span class="p">)</span>
<span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">get_mean_std</span><span class="p">(</span><span class="n">input_dtype</span><span class="o">.</span><span class="n">example</span><span class="p">()))</span>

<span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="p">(</span><span class="mf">9.811428143185347e+89</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Note</strong> - This strategy uses <strong>none_or_list_floats</strong> internally, and so the standard deviation and mean may or may not
be None.</p>
<p>13. <strong>get_bounds</strong> -  It’s often the case that we need to define a lower and an upper limit for generating certain values,
like floats, sequences, arrays_values etc. This strategy can be put to use when we want our function to pass on values
in any range  possible, or we’re unsure about the limits. We can also use the function to generate a list of possible
bounds wherein the function fails. For example-:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">input_dtype</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sampled_from</span><span class="p">(</span><span class="n">ivy_np</span><span class="o">.</span><span class="n">valid_int_dtypes</span><span class="p">)</span>
<span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">get_bounds</span><span class="p">(</span><span class="n">input_dtype</span><span class="o">.</span><span class="n">example</span><span class="p">()))</span>

<span class="p">(</span><span class="mi">73</span><span class="p">,</span> <span class="mi">36418</span><span class="p">)</span>
<span class="p">(</span><span class="mi">213</span><span class="p">,</span> <span class="mi">21716926</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Note</strong> - Under the hood, <strong>array_values</strong> strategy is called if the data type is <em>integer</em>, and <strong>none_or_list_of_floats</strong>
is called when the data type is <em>float</em>.</p>
<p>14. <strong>get_probs</strong> -  This is similar to the <strong>get_mean_std</strong> strategy, and is used to generate a tuple containing two values.
The first one being the <em>unnormalized probabilities</em> for all elements in a population, the second one being the <em>population size</em>.
For example-:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">input_dtype</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sampled_from</span><span class="p">(</span><span class="n">ivy_np</span><span class="o">.</span><span class="n">valid_float_dtypes</span><span class="p">)</span>
<span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">get_probs</span><span class="p">(</span><span class="n">input_dtype</span><span class="o">.</span><span class="n">example</span><span class="p">()))</span>

<span class="p">([[</span><span class="mf">6.103515625e-05</span><span class="p">,</span> <span class="mf">1.099609375</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">6.103515625e-05</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">6.103515625e-05</span><span class="p">]],</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Such strategies can be used to test statistical and probabilistic functions in Ivy.</p>
<p>15. <strong>get_axis</strong> - Similar to the <strong>valid_axes</strong> strategy, it generates an axis given any arbitrary shape as input.
For example-:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">get_axis</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>

<span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
<span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>16. <strong>num_positional_args</strong> - A helper function which generates the number of positional arguments, provided a function name
from any ivy submodule. For example -:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">print_hypothesis_examples</span><span class="p">(</span><span class="n">num_positional_args</span><span class="p">(</span><span class="s2">&quot;matmul&quot;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

<span class="mi">2</span>
<span class="mi">0</span>
<span class="mi">0</span>
</pre></div>
</div>
<p>This function generates any number of positional arguments within the range [0, number_positional_arguments]. It can be
helpful when we are testing a function with varied number of arguments.</p>
</section>
<section id="how-to-write-hypothesis-tests-effectively">
<h3>How to write Hypothesis Tests effectively<a class="headerlink" href="#how-to-write-hypothesis-tests-effectively" title="Permalink to this heading"></a></h3>
<p>It would be helpful to keep in mind the following points while writing test -:</p>
<ol class="loweralpha simple">
<li><p>Don’t use <code class="code docutils literal notranslate"><span class="pre">data.draw</span></code> in the function body.</p></li>
<li><p>Don’t use array generation (i.e. np.random_uniform) in the function body.</p></li>
<li><p>Don’t skip anything in the function body.</p></li>
<li><p>The function should only call helpers.test_function, and then possibly perform a custom value test if
<code class="code docutils literal notranslate"><span class="pre">test_values=False</span></code> in the arguments.</p></li>
<li><p>We should add as many possibilities as we can while generating data, covering all the function arguments</p></li>
<li><p>If you find yourself using repeating some logic which is specific to a particular submodule, then create a private
helper function and add this to the submodule.</p></li>
<li><p>If the logic is general enough, this can instead be added to the <code class="code docutils literal notranslate"><span class="pre">helpers.py</span></code> file, enabling it to be used for tests
in other submodules</p></li>
</ol>
</section>
<section id="bonus-hypothesis-extended-features">
<h3>Bonus: Hypothesis’ Extended Features<a class="headerlink" href="#bonus-hypothesis-extended-features" title="Permalink to this heading"></a></h3>
<p>1. <strong>Hypothesis</strong> performs <strong>Automated Test-Case Reduction</strong>. That is, the <strong>given</strong> decorator strives to report the simplest
set of input values that produce a given error. For the code block below-:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@given</span><span class="p">(</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span>
<span class="n">input_dtype</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sampled_from</span><span class="p">(</span><span class="n">ivy_np</span><span class="o">.</span><span class="n">valid_float_dtypes</span><span class="p">),</span>
<span class="n">as_variable</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">booleans</span><span class="p">()</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_demo</span><span class="p">(</span>
   <span class="n">data</span><span class="p">,</span>
   <span class="n">input_dtype</span><span class="p">,</span>
   <span class="n">as_variable</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">get_shape</span><span class="p">(</span><span class="n">min_num_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1">#failing assertions</span>
    <span class="k">assert</span> <span class="n">as_variable</span> <span class="o">==</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="n">shape</span> <span class="o">==</span> <span class="mi">0</span>

<span class="n">test_demo</span><span class="p">()</span>
</pre></div>
</div>
<p>Hypothesis reports the following -:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Falsifying</span> <span class="n">example</span><span class="p">:</span> <span class="n">failing_test</span><span class="p">(</span>
<span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="n">input_dtype</span><span class="o">=</span><span class="s1">&#39;float16&#39;</span><span class="p">,</span> <span class="n">as_variable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">Draw</span> <span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="n">File</span> <span class="s2">&quot;&lt;file_name&gt;.py&quot;</span> <span class="n">line</span> <span class="s2">&quot;123&quot;</span><span class="p">,</span> <span class="ow">in</span> <span class="n">test_demo</span>
<span class="k">assert</span> <span class="n">as_variable</span> <span class="o">==</span> <span class="kc">False</span>
<span class="ne">AssertionError</span>

<span class="n">Falsifying</span> <span class="n">example</span><span class="p">:</span> <span class="n">failing_test</span><span class="p">(</span>
<span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="n">input_dtype</span><span class="o">=</span><span class="s1">&#39;float16&#39;</span><span class="p">,</span> <span class="n">as_variable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">Draw</span> <span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">assert</span> <span class="n">shape</span> <span class="o">==</span> <span class="mi">0</span>
<span class="ne">AssertionError</span>
</pre></div>
</div>
<p>As can be seen from the output above, the given decorator will report the <em>simplest</em> set of input values that produce a
given error. This is done through the process of <strong>Shrinking</strong>.</p>
<p>Each of the Hypothesis’ strategies has it’s own prescribed shrinking behavior. For integers, it will identify the integer
closest to 0 that produces the error at hand. Checkout the <a class="reference external" href="https://hypothesis.readthedocs.io/en/latest/quickstart.html">documentation</a> for more information on shrinking behaviors of
other strategies.</p>
<p>Hypothesis doesn’t search for falsifying examples from scratch every time the test is run. Instead, it save a database of
these examples associated with each of the project’s test functions. In the case of Ivy, the <code class="code docutils literal notranslate"><span class="pre">.hypothesis</span></code> cache
folder is generated if one doesn’t exist, otherwise the existing one is added to it. We just preserve this folder on the
CI, so that each commit uses the same folder, and so it is ignored by git, thereby never forming part of the <code class="code docutils literal notranslate"><span class="pre">commit</span></code>.</p>
<ol class="arabic simple" start="2">
<li><p><strong>–-hypothesis-show-statistics</strong></p></li>
</ol>
<p>This feature helps is debugging the tests, with methods like <strong>note()</strong>, custom <strong>event()s</strong> where addition to the summary,
and a variety performance details are supported. Let’s look at the function <a class="reference external" href="https://github.com/unifyai/ivy/blob/master/ivy_tests/test_ivy/test_stateful/test_activations.py#L52">test_gelu</a> -:</p>
<p><strong>run</strong> <code class="code docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">—hypothesis-show-statistics</span> <span class="pre">&lt;test_file&gt;.py</span></code></p>
<p>This test runs for every backend, and the output is shown below-:</p>
<ul class="simple">
<li><p><strong>Jax</strong></p></li>
</ul>
<a class="reference internal image-reference" href="https://github.com/unifyai/ivy/blob/master/.idea/Jax.png"><img alt="https://github.com/unifyai/ivy/blob/master/.idea/Jax.png" src="https://github.com/unifyai/ivy/blob/master/.idea/Jax.png" style="width: 600px;" /></a>
<ul class="simple">
<li><p><strong>Numpy</strong></p></li>
</ul>
<a class="reference internal image-reference" href="https://github.com/unifyai/ivy/blob/master/.idea/numpy.png"><img alt="https://github.com/unifyai/ivy/blob/master/.idea/numpy.png" src="https://github.com/unifyai/ivy/blob/master/.idea/numpy.png" style="width: 600px;" /></a>
<ul class="simple">
<li><p><strong>Tensorflow</strong></p></li>
</ul>
<a class="reference internal image-reference" href="https://github.com/unifyai/ivy/blob/master/.idea/tensorflow.png"><img alt="https://github.com/unifyai/ivy/blob/master/.idea/tensorflow.png" src="https://github.com/unifyai/ivy/blob/master/.idea/tensorflow.png" style="width: 600px;" /></a>
<ul class="simple">
<li><p><strong>Torch</strong></p></li>
</ul>
<a class="reference internal image-reference" href="https://github.com/unifyai/ivy/blob/master/.idea/torch.png"><img alt="https://github.com/unifyai/ivy/blob/master/.idea/torch.png" src="https://github.com/unifyai/ivy/blob/master/.idea/torch.png" style="width: 600px;" /></a>
<p>It can be seen that the function doesn’t fail for <strong>Jax</strong>, <strong>Numpy</strong> and <strong>Torch</strong>, which is clearly not the case with
<strong>Tensorflow</strong>, wherein 7 examples failed the test. One important thing to note is the number of values for which
<a href="#id2"><span class="problematic" id="id3">**</span></a>Shrinking**(discussed in brief above) happened. Statistics for both <em>generate phase</em>, and <em>shrink phase</em> if the test
fails are printed in the output. If the tests are re-run, <em>reuse phase</em> statistics are printed as well where notable
examples from previous runs are displayed.</p>
<p>Another argument which can be specified for a more detailed output is <strong>hypothesis-verbosity = verbose</strong>. Let’s look at
the newer output, for the same example -:</p>
<a class="reference internal image-reference" href="https://github.com/unifyai/ivy/blob/master/.idea/test_run.png"><img alt="https://github.com/unifyai/ivy/blob/master/.idea/test_run.png" src="https://github.com/unifyai/ivy/blob/master/.idea/test_run.png" style="width: 600px;" /></a>
<p>Like the output above, Hypothesis will print all the examples for which the test failed, when <strong>verbosity</strong> is set.</p>
<ol class="arabic simple" start="3">
<li><p>Some performance related settings which might be helpful to know are-:</p></li>
</ol>
<ul class="simple">
<li><dl class="simple">
<dt><strong>max_examples</strong> - The number of valid examples Hypothesis will run. It usually defaults to 100. Turning it up or down</dt><dd><p>will have an impact on the speed as well as the rigorousness of the tests.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>deadline</strong> - If an input takes longer than expected, it should be treated as an error. It is useful to detect weird</dt><dd><p>performance issues.</p>
</dd>
</dl>
</li>
</ul>
</section>
</section>
<section id="self-consistent-and-explicit-testing">
<h2>Self-Consistent and Explicit Testing<a class="headerlink" href="#self-consistent-and-explicit-testing" title="Permalink to this heading"></a></h2>
<p>The hypothesis data generation strategies ensure that we test for arbitrary variations in the function inputs,
but this makes it difficult to manually verify ground truth results for each input variation.
Therefore, we instead opt to test for self-consistency against the same Ivy function with a NumPy backend.
This is handled by <code class="code docutils literal notranslate"><span class="pre">test_array_function</span></code>, which is a helper function most unit tests defer to.
This function is explained in more detail in the following sub-section.</p>
<p>For <em>primary</em> functions, this approach works well.
Each backend implementation generally wraps an existing backend function,
and under the hood these implementations vary substantially.
This approach then generally suffices to correctly catch bugs for most <em>primary</em> functions.</p>
<p>However, for <em>compositional</em> and <em>mixed</em> functions, then it’s more likely that a bug could be missed.
With such functions, it’s possible that the bug exists in the shared <em>compositional</em> implementation,
and then the bug would be systematic across all backends,
including the <em>ground truth</em> NumPy which the value tests for all backends compare against.</p>
<p>Therefore, for all <em>mixed</em> and <em>compositional</em> functions,
the test should also be appended with known inputs and known ground truth outputs,
to safeguard against this inability for <code class="code docutils literal notranslate"><span class="pre">test_array_function</span></code> to catch systematic errors.
These should be added using <code class="code docutils literal notranslate"><span class="pre">pytest.mark.parametrize</span></code>.
However, we should still also include <code class="code docutils literal notranslate"><span class="pre">test_array_function</span></code> in the test,
so that we can still test for arbitrary variations in the input arguments.</p>
</section>
<section id="id4">
<h2>test_array_function<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h2>
<p>The helper <a class="reference external" href="https://github.com/unifyai/ivy/blob/0fc4a104e19266fb4a65f5ec52308ff816e85d78/ivy_tests/test_ivy/helpers.py#L401">test_array_function</a> tests that the function:</p>
<ol class="arabic simple">
<li><p>can handle the <code class="code docutils literal notranslate"><span class="pre">out</span></code> argument correctly</p></li>
<li><p>can be called as an instance method of the ivy.Array class</p></li>
<li><p>can accept ivy.Container instances in place of any arguments for <em>nestable</em> functions,
applying the function to the leaves of the container, and returning the resultant container</p></li>
<li><p>can be called as an instance method on the ivy.Container</p></li>
<li><p>is self-consistent with the function return values when using a NumPy backend</p></li>
</ol>
<p><code class="code docutils literal notranslate"><span class="pre">array</span></code> in the name <code class="code docutils literal notranslate"><span class="pre">test_array_function</span></code> simply refers to the fact that the function in question consumes
arrays in the arguments.</p>
<p>So when should <code class="code docutils literal notranslate"><span class="pre">test_array_function</span></code> be used?</p>
<p>The rule is simple, if the test should not pass any arrays in the input,
then we should not use the helper <code class="code docutils literal notranslate"><span class="pre">test_array_function</span></code>.
For example, <code class="code docutils literal notranslate"><span class="pre">ivy.num_gpus</span></code> does not receive any arrays in the input,
and so we should not make us of <code class="code docutils literal notranslate"><span class="pre">test_array_function</span></code> in the test implementation.</p>
<p><strong>Round Up</strong></p>
<p>This should have hopefully given you a good feel for how the tests are implemented in Ivy.</p>
<p>If you’re ever unsure of how best to proceed,
please feel free to engage with the <a class="reference external" href="https://github.com/unifyai/ivy/discussions/1304">ivy tests discussion</a>,
or reach out on <a class="reference external" href="https://discord.gg/ZVQdvbzNQJ">discord</a> in the <a class="reference external" href="https://discord.com/channels/799879767196958751/982738436383445073">ivy tests channel</a>!</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="13_array_api_tests.html" class="btn btn-neutral float-left" title="Array API Tests" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../contributing/4_open_tasks.html" class="btn btn-neutral float-right" title="Open Tasks" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2022, Ivy Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>